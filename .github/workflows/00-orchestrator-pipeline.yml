#! ğŸ” Workflow Avanzado - Orquestador CI/CD
#
# PROPÃ“SITO:
#   Demostrar cÃ³mo construir una pipeline CI/CD completa:
#   - Reutilizando workflows modulares (build, test, deploy)
#   - Controlando dependencias con 'needs'
#   - Encadenando inputs y outputs
#   - Aplicando buenas prÃ¡cticas de orquestaciÃ³n
#
# TRIGGER:
#   Se ejecuta en push a main y tambiÃ©n manualmente (workflow_dispatch)
#
# NIVEL: ğŸ”´ Avanzado
# --------------------------------------------------------------

name: 00 - Orchestrator CI/CD Pipeline

#! ğŸ“Œ Eventos que disparan la pipeline
on:
  push:
    branches: ["main"]
    # branches: ["dev"]
  workflow_dispatch:

#! âš™ï¸ Variables globales del pipeline
env:
  NODE_VERSION: 20
  DEPLOY_ENV: staging
  REGION: us-east-1

#! ğŸ§± DefiniciÃ³n de los jobs del pipeline
jobs:
  # =======================
  #  1: âš“ BASIC
  # =======================
  # call-basic:
  #   name: âš“ Basic Job
  #   uses: ./.github/workflows/01-basic.yml

  # =======================
  #  2: call VARIABLES
  # =======================
  # call-variable:
  #   needs: call-basic
  #   name: ğŸ“ Variables Job
  #   uses: ./.github/workflows/02-variables-and-secrets.yml

  # =======================
  #  3: ğŸ› ï¸ BUILD
  # =======================
  # call-build:
  #   name: ğŸ› ï¸ Build Job
  #   needs: call-variable
  #   uses: ./.github/workflows/03-reusable-build.yml
  # with:
  #   node-version: ${ { env.NODE_VERSION }}
  #   build-command: "npm run build"
  # secrets: inherit # Hereda secrets del repositorio

  # =======================
  #  4: ğŸ§ª TEST
  # =======================
  # call-test:
  #   name: ğŸ§ª Test Job
  #   needs: call-build
  #   uses: ./.github/workflows/04-reusable-test.yml
  #   with:
  #     node-version: ${ { env.NODE_VERSION }}
  #     test-command: "npm test"
  #   secrets: inherit

  # =======================
  #  5: ğŸš€ DEPLOY
  # =======================
  # call-deploy:
  #   name: ğŸš€ Deploy Job
  #   needs: call-test
  #   # Solo despliega en main
  #   if: ${{ github.ref_name == 'main' }}
  #   uses: ./.github/workflows/05-reusable-deploy.yml
  #   with:
  #     environment: ${ { env.DEPLOY_ENV }}
  #     region: ${ { env.REGION }}
  #     deploy-command: "echo 'Simulando despliegue en staging...'"
  #   secrets:
  #     DEPLOY_TOKEN: ${ { secrets.DEPLOY_TOKEN }}

  # =======================
  #  1: â“ CONDITIONALS
  # =======================
  # call-conditionals:
  #   name: â“ conditionals Job
  #   needs: call-deploy
  #   uses: ./.github/workflows/06-conditionals.yml

  # =======================
  #  4: ğŸ“Š REPORT / SUMMARY
  # =======================
  summary:
    name: ğŸ“Š Resumen del Pipeline
    runs-on: ubuntu-latest
    needs: [
        call-basic,
        # call-variable,
        # call-build,
        # call-test,
        # call-deploy,
        # call-conditionals,
      ]

    steps:
      - name: ğŸ§© Recopilar resultados
        run: |
          echo "ğŸ§± Build completado: âœ…"
          echo "ğŸ§ª Tests ejecutados: âœ…"
          # echo "ğŸš€ Despliegue en: ${{ env.DEPLOY_ENV }}"
          # echo "ğŸ“¦ RegiÃ³n: ${{ env.REGION }}"

      - name: ğŸ“ Generar reporte final
        run: |
          echo "=== Pipeline CI/CD completada correctamente ==="
          echo "Repositorio: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Fecha: $(date)"

      - name: ğŸ‰ FinalizaciÃ³n
        run: echo "ğŸ¯ CI/CD finalizada exitosamente ğŸš€"
